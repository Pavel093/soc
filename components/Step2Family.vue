<template>
  <div class="family-step">
    <h2 class="step-title dark-text">2. –°–æ—Å—Ç–∞–≤ —Å–µ–º—å–∏</h2>
    
    <!-- –†–∞–∑–¥–µ–ª –¥–ª—è –±–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö -->
    <div class="section" v-if="!hasChildren">
      <h3 class="section-title">–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å</h3>
      
      <label class="custom-checkbox">
        <input type="checkbox" v-model="isPregnant" />
        <span class="checkmark"></span>
        <span class="checkbox-text">
          –Ø –±–µ—Ä–µ–º–µ–Ω–Ω–∞ –∏ –≤—Å—Ç–∞–ª–∞ –Ω–∞ —É—á–µ—Ç –≤ —Ä–∞–Ω–Ω–∏–µ —Å—Ä–æ–∫–∏
          <span class="info-badge">–ü–æ—Å–æ–±–∏–µ –¥–ª—è –±–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</span>
        </span>
      </label>
      
      <div v-if="isPregnant" class="pregnancy-details">
        <div class="input-group">
          <label class="field-label">–°—Ä–æ–∫ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —É—á–µ—Ç (–Ω–µ–¥–µ–ª—å):</label>
          <input 
            type="number" 
            v-model.number="pregnancyWeeks"
            min="1"
            max="40"
            class="number-input"
            placeholder="12"
          />
        </div>
        
        <div v-if="pregnancyWeeks > 12" class="warning-box">
          ‚ö†Ô∏è –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–æ–±–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞—Ç—å –Ω–∞ —É—á–µ—Ç –¥–æ 12 –Ω–µ–¥–µ–ª—å –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏
        </div>
        
        <div v-else-if="pregnancyWeeks >= 6 && pregnancyWeeks <= 12" class="success-box">
          ‚úÖ –°—Ä–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–æ–±–∏—è
        </div>
        
        <div class="info-box">
          <p><strong>–†–∞–∑–º–µ—Ä –ø–æ—Å–æ–±–∏—è –¥–ª—è –±–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:</strong></p>
          <ul>
            <li>50%, 75% –∏–ª–∏ 100% –æ—Ç –ø—Ä–æ–∂–∏—Ç–æ—á–Ω–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞ —Ç—Ä—É–¥–æ—Å–ø–æ—Å–æ–±–Ω–æ–≥–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—è</li>
            <li>–í—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è —Å –º–µ—Å—è—Ü–∞ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —É—á–µ—Ç –¥–æ –º–µ—Å—è—Ü–∞ —Ä–æ–¥–æ–≤</li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- –†–∞–∑–¥–µ–ª –¥–ª—è –¥–µ—Ç–µ–π -->
    <div class="section">
      <h3 class="section-title">–î–µ—Ç–∏</h3>
      
      <div class="children-section">
        <div class="input-group">
          <label class="field-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π –¥–æ 17 –ª–µ—Ç:</label>
          <div class="counter-group">
            <button 
              class="counter-btn" 
              @click="decrementChildren" 
              :disabled="childrenCount <= 0"
            >
              -
            </button>
            <input 
              type="number" 
              v-model.number="childrenCount"
              min="0"
              max="20"
              class="counter-input"
              readonly
            />
            <button 
              class="counter-btn" 
              @click="incrementChildren" 
              :disabled="childrenCount >= 20"
            >
              +
            </button>
          </div>
        </div>
        
        <div v-if="childrenCount > 0" class="children-details">
          <div class="info-box">
            <p><strong>–ï–¥–∏–Ω–æ–µ –ø–æ—Å–æ–±–∏–µ –Ω–∞ –¥–µ—Ç–µ–π –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è:</strong></p>
            <ul>
              <li>–ù–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞ –æ—Ç 0 –¥–æ 17 –ª–µ—Ç</li>
              <li>–†–∞–∑–º–µ—Ä: 50%, 75% –∏–ª–∏ 100% –æ—Ç –ø—Ä–æ–∂–∏—Ç–æ—á–Ω–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞ –Ω–∞ —Ä–µ–±–µ–Ω–∫–∞</li>
              <li v-if="childrenCount > 1">–£ –≤–∞—Å {{ childrenCount }} –¥–µ—Ç–µ–π - –ø–æ—Å–æ–±–∏–µ –±—É–¥–µ—Ç –Ω–∞ –∫–∞–∂–¥–æ–≥–æ</li>
            </ul>
          </div>
          
          <!-- –í–æ–∑—Ä–∞—Å—Ç –¥–µ—Ç–µ–π –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ -->
          <div v-if="childrenCount > 0" class="age-distribution">
            <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</h4>
            
            <div class="age-group">
              <label class="field-label">–î–µ—Ç–∏ –æ—Ç 0 –¥–æ 3 –ª–µ—Ç:</label>
              <input 
                type="number" 
                v-model.number="childrenAges.under3"
                min="0"
                :max="childrenCount"
                class="small-input"
                @input="validateAgeDistribution"
              />
            </div>
            
            <div class="age-group">
              <label class="field-label">–î–µ—Ç–∏ –æ—Ç 3 –¥–æ 7 –ª–µ—Ç:</label>
              <input 
                type="number" 
                v-model.number="childrenAges.from3to7"
                min="0"
                :max="childrenCount"
                class="small-input"
                @input="validateAgeDistribution"
              />
            </div>
            
            <div class="age-group">
              <label class="field-label">–î–µ—Ç–∏ –æ—Ç 8 –¥–æ 17 –ª–µ—Ç:</label>
              <input 
                type="number" 
                v-model.number="childrenAges.from8to17"
                min="0"
                :max="childrenCount"
                class="small-input"
                @input="validateAgeDistribution"
              />
            </div>
            
            <p v-if="ageSum !== childrenCount && ageSum > 0" class="error-text">
              ‚ö†Ô∏è –°—É–º–º–∞ –¥–µ—Ç–µ–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–º ({{ ageSum }}) –Ω–µ —Ä–∞–≤–Ω–∞ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É ({{ childrenCount }})
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
    <div class="section">
      <h3 class="section-title">–°—Ç—É–¥–µ–Ω—Ç—ã</h3>
      
      <label class="custom-checkbox">
        <input type="checkbox" v-model="hasStudents" />
        <span class="checkmark"></span>
        <span class="checkbox-text">
          –í —Å–µ–º—å–µ –µ—Å—Ç—å –¥–µ—Ç–∏ –æ—Ç 18 –¥–æ 23 –ª–µ—Ç, –æ–±—É—á–∞—é—â–∏–µ—Å—è –æ—á–Ω–æ
        </span>
      </label>
      
      <div v-if="hasStudents" class="students-details">
        <div class="input-group">
          <label class="field-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –æ—á–Ω–æ–π —Ñ–æ—Ä–º—ã (18-23 –≥–æ–¥–∞):</label>
          <div class="counter-group">
            <button 
              class="counter-btn" 
              @click="studentsCount = Math.max(0, studentsCount - 1)" 
              :disabled="studentsCount <= 0"
            >
              -
            </button>
            <input 
              type="number" 
              v-model.number="studentsCount"
              min="0"
              max="10"
              class="counter-input"
              readonly
            />
            <button 
              class="counter-btn" 
              @click="studentsCount++" 
              :disabled="studentsCount >= 10"
            >
              +
            </button>
          </div>
        </div>
        
        <div class="info-box">
          <p>‚ÑπÔ∏è –°—Ç—É–¥–µ–Ω—Ç—ã 18-23 –ª–µ—Ç —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Å–æ—Å—Ç–∞–≤–µ —Å–µ–º—å–∏, –Ω–æ –ø–æ—Å–æ–±–∏–µ –Ω–∞ –Ω–∏—Ö –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è</p>
        </div>
      </div>
    </div>
    
    <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —Å—É–ø—Ä—É–≥–∞ -->
    <div class="section">
      <h3 class="section-title">–°—É–ø—Ä—É–≥(–∞)</h3>
      
      <label class="custom-checkbox">
        <input type="checkbox" v-model="hasSpouse" />
        <span class="checkmark"></span>
        <span class="checkbox-text">
          –°–æ—Å—Ç–æ—é –≤ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –±—Ä–∞–∫–µ
        </span>
      </label>
      
      <div v-if="!hasSpouse && childrenCount > 0" class="single-parent-info">
        <label class="custom-checkbox">
          <input type="checkbox" v-model="isSingleParent" />
          <span class="checkmark"></span>
          <span class="checkbox-text">
            –Ø –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–æ–¥–∏—Ç–µ–ª—å
            <span class="info-badge">–ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –ø–æ—Å–æ–±–∏–µ</span>
          </span>
        </label>
        
        <div v-if="isSingleParent" class="info-box">
          <p><strong>–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–æ–¥–∏—Ç–µ–ª—å - —ç—Ç–æ:</strong></p>
          <ul>
            <li>–í—Ç–æ—Ä–æ–π —Ä–æ–¥–∏—Ç–µ–ª—å —É–º–µ—Ä, –ø—Ä–∏–∑–Ω–∞–Ω –±–µ–∑–≤–µ—Å—Ç–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º –∏–ª–∏ —É–º–µ—Ä—à–∏–º</li>
            <li>–í —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–µ –æ —Ä–æ–∂–¥–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –æ–± –æ—Ç—Ü–µ</li>
            <li>–ó–∞–ø–∏—Å—å –æ–± –æ—Ç—Ü–µ —Å–¥–µ–ª–∞–Ω–∞ —Å–æ —Å–ª–æ–≤ –º–∞—Ç–µ—Ä–∏</li>
          </ul>
          <p class="success-text">‚úÖ –†–∞–∑–º–µ—Ä –ø–æ—Å–æ–±–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É–≤–µ–ª–∏—á–µ–Ω</p>
        </div>
      </div>
    </div>
    
    <!-- –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–º—å–µ -->
    <div class="family-summary">
      <h4>–°–æ—Å—Ç–∞–≤ –≤–∞—à–µ–π —Å–µ–º—å–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–æ—Å–æ–±–∏—è:</h4>
      
      <div class="summary-grid">
        <div class="summary-item">
          <span class="label">–í–∑—Ä–æ—Å–ª—ã–µ:</span>
          <span class="value">{{ adultsCount }}</span>
        </div>
        
        <div class="summary-item" v-if="childrenCount > 0">
          <span class="label">–î–µ—Ç–∏ –¥–æ 17:</span>
          <span class="value">{{ childrenCount }}</span>
        </div>
        
        <div class="summary-item" v-if="hasStudents">
          <span class="label">–°—Ç—É–¥–µ–Ω—Ç—ã 18-23:</span>
          <span class="value">{{ studentsCount }}</span>
        </div>
        
        <div class="summary-item total">
          <span class="label">–í—Å–µ–≥–æ —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏:</span>
          <span class="value">{{ totalFamilySize }}</span>
        </div>
      </div>
      
      <div v-if="isPregnant && !hasChildren" class="special-note">
        <p>ü§∞ –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–æ—Å–æ–±–∏–µ –¥–ª—è –±–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</p>
      </div>
      
      <div v-if="childrenCount > 0" class="special-note">
        <p>üë∂ –ü–æ—Å–æ–±–∏–µ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –Ω–∞ {{ childrenCount }} {{ childrenText }}</p>
      </div>
      
      <div v-if="childrenCount >= 3" class="special-note bonus">
        <p>üåü –£ –≤–∞—Å –º–Ω–æ–≥–æ–¥–µ—Ç–Ω–∞—è —Å–µ–º—å—è - –¥–µ–π—Å—Ç–≤—É—é—Ç –æ—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è –ø–æ –∏–º—É—â–µ—Å—Ç–≤—É</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { useCalculatorStore } from '../stores/calculatorStore'

const store = useCalculatorStore()

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
const isPregnant = ref(false)
const pregnancyWeeks = ref(0)
const childrenCount = ref(0)
const hasStudents = ref(false)
const studentsCount = ref(0)
const hasSpouse = ref(false)
const isSingleParent = ref(false)

// –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ—Ç–µ–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–º
const childrenAges = ref({
  under3: 0,
  from3to7: 0,
  from8to17: 0
})

// –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
const hasChildren = computed(() => childrenCount.value > 0)

const adultsCount = computed(() => {
  return (hasSpouse.value ? 2 : 1)
})

const totalFamilySize = computed(() => {
  return adultsCount.value + childrenCount.value + (hasStudents.value ? studentsCount.value : 0)
})

const ageSum = computed(() => {
  return childrenAges.value.under3 + 
         childrenAges.value.from3to7 + 
         childrenAges.value.from8to17
})

const childrenText = computed(() => {
  const count = childrenCount.value
  if (count === 1) return '—Ä–µ–±–µ–Ω–∫–∞'
  if (count >= 2 && count <= 4) return '–¥–µ—Ç–µ–π'
  return '–¥–µ—Ç–µ–π'
})

// –ú–µ—Ç–æ–¥—ã
const incrementChildren = () => {
  if (childrenCount.value < 20) {
    childrenCount.value++
  }
}

const decrementChildren = () => {
  if (childrenCount.value > 0) {
    childrenCount.value--
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–º
    if (childrenCount.value === 0) {
      childrenAges.value = {
        under3: 0,
        from3to7: 0,
        from8to17: 0
      }
    }
  }
}

const validateAgeDistribution = () => {
  const sum = childrenAges.value.under3 + 
              childrenAges.value.from3to7 + 
              childrenAges.value.from8to17
  
  if (sum > childrenCount.value) {
    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    const ratio = childrenCount.value / sum
    childrenAges.value.under3 = Math.floor(childrenAges.value.under3 * ratio)
    childrenAges.value.from3to7 = Math.floor(childrenAges.value.from3to7 * ratio)
    childrenAges.value.from8to17 = Math.floor(childrenAges.value.from8to17 * ratio)
  }
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
watch(isPregnant, (value) => {
  store.isPregnant = value
  if (!value) {
    pregnancyWeeks.value = 0
    store.pregnancyWeeks = 0
  }
})

watch(pregnancyWeeks, (value) => {
  store.pregnancyWeeks = value
})

watch(childrenCount, (value) => {
  store.childrenCount = value
})

watch(hasStudents, (value) => {
  store.hasStudents = value
  if (!value) {
    studentsCount.value = 0
    store.studentsCount = 0
  }
})

watch(studentsCount, (value) => {
  store.studentsCount = value
})

watch(hasSpouse, (value) => {
  store.hasSpouse = value
  if (value) {
    isSingleParent.value = false
  }
})

watch(isSingleParent, (value) => {
  store.isSingleParent = value
})

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
isPregnant.value = store.isPregnant
pregnancyWeeks.value = store.pregnancyWeeks
childrenCount.value = store.childrenCount
hasStudents.value = store.hasStudents
studentsCount.value = store.studentsCount
hasSpouse.value = store.hasSpouse
</script>


<style scoped lang="scss">
.family-step{
  display: flex;
  flex-wrap: wrap;
  gap: 28px;
  margin-top: 24px;
  h2{
    position: absolute;
    top: 15px;
    left: calc(15px + 69px + 15px);
    font-weight: 300;
    font-size: 25px;
    max-width: 90%;
    letter-spacing: 1.02px;
    line-height: 0.9;
  }
  .spouse-section{
    width: 100%;
    label{
      display: flex;
      align-items: center;
      min-height: 22px;
      padding-left: 30px;
    }
  }
  .children-section, .students-section {
    width: 100%;
    .input-group{
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      align-items: center;
      .input-numbers{
        display: flex;
        align-items: center;
        gap: 6px;
        input[type="number"] {
          width: 60px;
          height: 38px;
          border: 1px solid #C4C2FF;
          border-radius: 5px;
          display: flex;
          align-items: center;
          justify-content: center;
          text-align: center;
          font-size: 17px;
          padding-left: 0px; 
          -moz-appearance: textfield; 
          appearance: textfield; 
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        .minus, .plus{
          width: 32px;
          height: 32px;
          background-color: #008CFF;
          display: flex;
          border: none;
          border-radius: 7px;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          &:disabled {
            background-color: #31a3ff;
            cursor: not-allowed;
          }
        }
      }
    }
  }

  .students-section{
    display: flex;
    flex-wrap: wrap;
    height: max-content;
    label{
      display: flex;
      align-items: center;
      min-height: 22px;
      padding-left: 30px;
    }
    .two{
      margin-top:18px;
    }
  }
}
</style>